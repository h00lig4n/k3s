apiVersion: v1
kind: ConfigMap
metadata:
  name: cert-writer-config
  namespace: common
  annotations:
    argocd-envsubst/skip: "true"
data:
  run.sh: |
    #!/bin/sh
    set -e

    apk add --no-cache openssh coreutils

    mkdir -p /exports/tls-certificate

    while true; do
      echo "cert-writer loop running..."

      cp -Lf /certs/* /exports/tls-certificate/ 2>/dev/null || true

      if [ ! -f "/exports/tls-certificate/tls.crt" ] || [ ! -f "/exports/tls-certificate/tls.key" ]; then
        echo "Missing tls.crt or tls.key"
        ls -l /exports/tls-certificate
        sleep 3600
        continue
      fi

      cat /exports/tls-certificate/tls.crt /exports/tls-certificate/tls.key > /exports/tls-certificate/server.pem
      chmod 600 /exports/tls-certificate/server.pem

      if [ -z "$EDGE_USER" ] || [ -z "$EDGE_HOST" ]; then
        echo "EDGE_USER or EDGE_HOST not set"
        env | grep EDGE || true
        sleep 3600
        continue
      fi

      NEWSUM=$(sha256sum /exports/tls-certificate/server.pem | awk '{print $1}')
      OLDSUM=""
      [ -f /exports/tls-certificate/.server.pem.sha256 ] && OLDSUM=$(cat /exports/tls-certificate/.server.pem.sha256)

      if [ "$NEWSUM" != "$OLDSUM" ]; then
        echo "Certificate changed, syncing to EdgeRouter..."
        echo "Target: $EDGE_USER@$EDGE_HOST"

        scp -v -i /root/.ssh/id_ed25519 -o StrictHostKeyChecking=no \
          /exports/tls-certificate/server.pem "$EDGE_USER@$EDGE_HOST:/config/auth/certificates/server.pem"

        ssh -v -i /root/.ssh/id_ed25519 -o StrictHostKeyChecking=no \
          "$EDGE_USER@$EDGE_HOST" "restart gui"

        echo "$NEWSUM" > /exports/tls-certificate/.server.pem.sha256
      else
        echo "Certificate unchanged."
      fi

      sleep 3600
    done
